# =============================================================================
# BCEM Test Runner â€” Everything runs in containers
#
# Usage:
#   docker compose -f docker-compose.test.yml run analysis-test
#   docker compose -f docker-compose.test.yml run verdict-test
#   docker compose -f docker-compose.test.yml run ingestion-test
#
#   # Run all tests:
#   docker compose -f docker-compose.test.yml up --build --abort-on-container-exit
# =============================================================================

services:
  # --- Analysis Engine Tests ---
  analysis-test:
    build:
      context: .
      dockerfile: analysis/Dockerfile
    command: pytest tests/ -v --tb=short
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy

  # --- Verdict Worker Tests ---
  verdict-test:
    build:
      context: .
      dockerfile: verdict/Dockerfile
    command: pytest tests/ -v --tb=short
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=postgresql://ices:ices_dev@postgres-test:5432/ices
    depends_on:
      redis:
        condition: service_healthy
      postgres-test:
        condition: service_healthy

  # --- Go Ingestion Tests (uses multi-stage build) ---
  ingestion-test:
    build:
      context: ./ingestion
      target: test

  # --- Redis (needed by Python tests) ---
  redis:
    image: redis:7-alpine
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 2s
      timeout: 2s
      retries: 5

  # --- Postgres (needed by DB dedup tests) ---
  postgres-test:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ices
      POSTGRES_PASSWORD: ices_dev
      POSTGRES_DB: ices
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ices" ]
      interval: 2s
      timeout: 2s
      retries: 5
