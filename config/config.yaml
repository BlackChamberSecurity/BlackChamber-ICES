# =============================================================================
# BlackChamber ICES Configuration
# =============================================================================

tenants:
  - alias: "mainmethod"
    provider: "m365"
    tenant_id: "${M365_TENANT_ID_1}"
    client_id: "${M365_CLIENT_ID_1}"
    client_secret: "${M365_CLIENT_SECRET_1}"
    # Hybrid discovery: empty include_users = auto-discover all licensed users
    include_users: []
    exclude_users: []

  # Add more tenants here:
  # - alias: "acme-corp"
  #   provider: "m365"
  #   tenant_id: "${M365_TENANT_ID_2}"
  #   client_id: "${M365_CLIENT_ID_2}"
  #   client_secret: "${M365_CLIENT_SECRET_2}"
  #   include_users: []
  #   exclude_users:
  #     - "noreply@acme-corp.com"

redis:
  url: "${REDIS_URL:-redis://localhost:6379/0}"
  queues:
    emails: "emails"
    verdicts: "verdicts"

# =============================================================================
# Ingestion — subscription lifecycle and delta sync
# =============================================================================
ingestion:
  subscription_renewal_buffer: "30m"
  delta_sync_interval: "15m"
  delta_lookback_on_start: "24h"

# =============================================================================
# Database
# =============================================================================
database:
  url: "${DATABASE_URL:-postgresql://ices:ices_dev@postgres:5432/ices}"

# =============================================================================
# Policies — rules that reference observation keys and values
#
# Scope fields (all default to "*" = any):
#   tenant     — tenant alias or "*"
#   sender     — exact email, domain wildcard ("*@*.xyz"), or "*"
#   recipients — exact email, list of emails, or "*"
#
# Observation match types:
#   equals   — exact match (pass/fail, text)
#   gte/lte  — numeric comparison
#   contains — substring or list membership
#   exists   — observation key is present
#
# Action priority: delete > quarantine > tag > none
# =============================================================================
policies:
  - name: quarantine-dmarc-failure
    tenant: "*"
    sender: "*"
    recipients: "*"
    when:
      analyzer: header_auth
      observation: dmarc
      equals: "fail"
    action: quarantine

  - name: tag-suspicious-urls
    tenant: "*"
    when:
      analyzer: url_check
      observation: ip_urls_found
      gte: 1
    action: tag

  - name: quarantine-dangerous-attachment
    tenant: "*"
    when:
      analyzer: attachment_check
      observation: dangerous_extensions
      exists: true
    action: quarantine

  # SaaS usage has no security policy — informational only.
  # All observations are persisted to Postgres for reporting.
