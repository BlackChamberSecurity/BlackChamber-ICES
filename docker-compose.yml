version: "3.9"

services:
  # ---------------------------------------------------------------------------
  # Redis — single broker for Celery + inter-service queue
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - redis_data:/data

  # ---------------------------------------------------------------------------
  # Postgres — system of record for analysis results + policy outcomes
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: bcem
      POSTGRES_USER: bcem
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bcem_dev}
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U bcem" ]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - pg_data:/var/lib/postgresql/data

  # ---------------------------------------------------------------------------
  # Go Ingestion Service — M365 webhooks + email fetching
  # ---------------------------------------------------------------------------
  ingestion:
    build: ./ingestion
    ports:
      - "8080:8080"
      - "${WEBHOOK_PORT:-8081}:8081"
    env_file: .env
    volumes:
      - ./config/config.yaml:/app/config/config.yaml:ro
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Python Analysis Workers — Celery workers processing email analysis
  # ---------------------------------------------------------------------------
  analysis-worker:
    build: ./analysis
    command: >
      celery -A analysis.celery_app worker -Q emails -l info --concurrency=${ANALYSIS_WORKERS:-4}
    env_file: .env
    volumes:
      - ./shared:/app/shared:ro
      - ./config/config.yaml:/app/config/config.yaml:ro
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    deploy:
      replicas: 2
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Python Verdict Workers — policy evaluation + actions via Graph API
  # ---------------------------------------------------------------------------
  verdict-worker:
    build: ./verdict
    command: >
      celery -A verdict.celery_app worker -Q verdicts -l info --concurrency=${VERDICT_WORKERS:-2}
    env_file: .env
    volumes:
      - ./shared:/app/shared:ro
      - ./config/config.yaml:/app/config/config.yaml:ro
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Celery Beat — periodic task scheduler (batch flush timer)
  # ---------------------------------------------------------------------------
  verdict-beat:
    build: ./verdict
    command: >
      celery -A verdict.celery_app beat -l info
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # ngrok tunnel (dev only — enables webhook testing without a public domain)
  # Start with: docker compose --profile dev up
  # ---------------------------------------------------------------------------
  ngrok:
    image: ngrok/ngrok:latest
    command: http ingestion:8081 --log stdout
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:-}
    ports:
      - "4040:4040"
    depends_on:
      - ingestion
    profiles:
      - dev

volumes:
  redis_data:
  pg_data:
